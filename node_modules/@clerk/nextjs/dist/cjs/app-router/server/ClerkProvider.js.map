{"version":3,"sources":["../../../../src/app-router/server/ClerkProvider.tsx"],"sourcesContent":["import type { AuthObject } from '@clerk/backend';\nimport type { InitialState, Without } from '@clerk/types';\nimport { headers } from 'next/headers';\nimport React from 'react';\n\nimport { PromisifiedAuthProvider } from '../../client-boundary/PromisifiedAuthProvider';\nimport { getDynamicAuthData } from '../../server/buildClerkProps';\nimport type { NextClerkProviderProps } from '../../types';\nimport { canUseKeyless__server } from '../../utils/feature-flags';\nimport { mergeNextClerkPropsWithEnv } from '../../utils/mergeNextClerkPropsWithEnv';\nimport { isNext13 } from '../../utils/sdk-versions';\nimport { ClientClerkProvider } from '../client/ClerkProvider';\nimport { buildRequestLike, getScriptNonceFromHeader } from './utils';\n\nconst getDynamicClerkState = React.cache(async function getDynamicClerkState() {\n  const request = await buildRequestLike();\n  const data = getDynamicAuthData(request);\n\n  return data;\n});\n\nconst getNonceFromCSPHeader = React.cache(async function getNonceFromCSPHeader() {\n  return getScriptNonceFromHeader((await headers()).get('Content-Security-Policy') || '') || '';\n});\n\nexport async function ClerkProvider(\n  props: Without<NextClerkProviderProps, '__unstable_invokeMiddlewareOnAuthStateChange'>,\n) {\n  const { children, dynamic, ...rest } = props;\n  let statePromise: Promise<null | AuthObject> = Promise.resolve(null);\n  let nonce = Promise.resolve('');\n\n  if (dynamic) {\n    if (isNext13) {\n      /**\n       * For some reason, Next 13 requires that functions which call `headers()` are awaited where they are invoked.\n       * Without the await here, Next will throw a DynamicServerError during build.\n       */\n      statePromise = Promise.resolve(await getDynamicClerkState());\n      nonce = Promise.resolve(await getNonceFromCSPHeader());\n    } else {\n      statePromise = getDynamicClerkState();\n      nonce = getNonceFromCSPHeader();\n    }\n  }\n\n  const propsWithEnvs = mergeNextClerkPropsWithEnv({\n    ...rest,\n  });\n\n  let output = (\n    <ClientClerkProvider\n      {...mergeNextClerkPropsWithEnv(rest)}\n      nonce={await nonce}\n      initialState={await statePromise}\n    >\n      {children}\n    </ClientClerkProvider>\n  );\n\n  const shouldRunAsKeyless = !propsWithEnvs.publishableKey && canUseKeyless__server;\n\n  if (shouldRunAsKeyless) {\n    // NOTE: Create or read keys on every render. Usually this means only on hard refresh or hard navigations.\n    const newOrReadKeys = await import('../../server/keyless-node.js').then(mod => mod.createOrReadKeyless());\n\n    if (newOrReadKeys) {\n      const KeylessCookieSync = await import('../client/keyless-cookie-sync.js').then(mod => mod.KeylessCookieSync);\n      output = (\n        <KeylessCookieSync {...newOrReadKeys}>\n          <ClientClerkProvider\n            {...mergeNextClerkPropsWithEnv({\n              ...rest,\n              publishableKey: newOrReadKeys.publishableKey,\n              __internal_claimKeylessApplicationUrl: newOrReadKeys.claimUrl,\n              __internal_copyInstanceKeysUrl: newOrReadKeys.apiKeysUrl,\n            })}\n            nonce={await nonce}\n            initialState={await statePromise}\n          >\n            {children}\n          </ClientClerkProvider>\n        </KeylessCookieSync>\n      );\n    }\n  }\n\n  if (dynamic) {\n    return (\n      // TODO: fix types so AuthObject is compatible with InitialState\n      <PromisifiedAuthProvider authPromise={statePromise as unknown as Promise<InitialState>}>\n        {output}\n      </PromisifiedAuthProvider>\n    );\n  }\n\n  return output;\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA,qBAAwB;AACxB,mBAAkB;AAElB,qCAAwC;AACxC,6BAAmC;AAEnC,2BAAsC;AACtC,wCAA2C;AAC3C,0BAAyB;AACzB,2BAAoC;AACpC,mBAA2D;AAE3D,MAAM,uBAAuB,aAAAA,QAAM,MAAM,eAAeC,wBAAuB;AAC7E,QAAM,UAAU,UAAM,+BAAiB;AACvC,QAAM,WAAO,2CAAmB,OAAO;AAEvC,SAAO;AACT,CAAC;AAED,MAAM,wBAAwB,aAAAD,QAAM,MAAM,eAAeE,yBAAwB;AAC/E,aAAO,wCAA0B,UAAM,wBAAQ,GAAG,IAAI,yBAAyB,KAAK,EAAE,KAAK;AAC7F,CAAC;AAED,eAAsB,cACpB,OACA;AACA,QAAM,EAAE,UAAU,SAAS,GAAG,KAAK,IAAI;AACvC,MAAI,eAA2C,QAAQ,QAAQ,IAAI;AACnE,MAAI,QAAQ,QAAQ,QAAQ,EAAE;AAE9B,MAAI,SAAS;AACX,QAAI,8BAAU;AAKZ,qBAAe,QAAQ,QAAQ,MAAM,qBAAqB,CAAC;AAC3D,cAAQ,QAAQ,QAAQ,MAAM,sBAAsB,CAAC;AAAA,IACvD,OAAO;AACL,qBAAe,qBAAqB;AACpC,cAAQ,sBAAsB;AAAA,IAChC;AAAA,EACF;AAEA,QAAM,oBAAgB,8DAA2B;AAAA,IAC/C,GAAG;AAAA,EACL,CAAC;AAED,MAAI,SACF,6BAAAF,QAAA;AAAA,IAAC;AAAA;AAAA,MACE,OAAG,8DAA2B,IAAI;AAAA,MACnC,OAAO,MAAM;AAAA,MACb,cAAc,MAAM;AAAA;AAAA,IAEnB;AAAA,EACH;AAGF,QAAM,qBAAqB,CAAC,cAAc,kBAAkB;AAE5D,MAAI,oBAAoB;AAEtB,UAAM,gBAAgB,MAAM,OAAO,8BAA8B,EAAE,KAAK,SAAO,IAAI,oBAAoB,CAAC;AAExG,QAAI,eAAe;AACjB,YAAM,oBAAoB,MAAM,OAAO,kCAAkC,EAAE,KAAK,SAAO,IAAI,iBAAiB;AAC5G,eACE,6BAAAA,QAAA,cAAC,qBAAmB,GAAG,iBACrB,6BAAAA,QAAA;AAAA,QAAC;AAAA;AAAA,UACE,OAAG,8DAA2B;AAAA,YAC7B,GAAG;AAAA,YACH,gBAAgB,cAAc;AAAA,YAC9B,uCAAuC,cAAc;AAAA,YACrD,gCAAgC,cAAc;AAAA,UAChD,CAAC;AAAA,UACD,OAAO,MAAM;AAAA,UACb,cAAc,MAAM;AAAA;AAAA,QAEnB;AAAA,MACH,CACF;AAAA,IAEJ;AAAA,EACF;AAEA,MAAI,SAAS;AACX;AAAA;AAAA,MAEE,6BAAAA,QAAA,cAAC,0DAAwB,aAAa,gBACnC,MACH;AAAA;AAAA,EAEJ;AAEA,SAAO;AACT;","names":["React","getDynamicClerkState","getNonceFromCSPHeader"]}